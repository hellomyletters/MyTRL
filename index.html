<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting...</title>
</head>
<body>

<script>
    // --- 1. Initial Loader Setup (Same as your original) ---
    const connectingLoaderDiv = document.createElement('div');
    connectingLoaderDiv.id = 'connectingLoader';
    connectingLoaderDiv.style.position = 'fixed';
    connectingLoaderDiv.style.top = '0';
    connectingLoaderDiv.style.left = '0';
    connectingLoaderDiv.style.width = '100%';
    connectingLoaderDiv.style.height = '100%';
    connectingLoaderDiv.style.backgroundColor = '#fff';
    connectingLoaderDiv.style.display = 'flex';
    connectingLoaderDiv.style.alignItems = 'center';
    connectingLoaderDiv.style.justifyContent = 'center';
    connectingLoaderDiv.style.fontSize = '24px';
    connectingLoaderDiv.style.fontWeight = 'bold';
    connectingLoaderDiv.style.zIndex = '9999';
    connectingLoaderDiv.innerText = 'Connecting';
    document.body.appendChild(connectingLoaderDiv);

    let dotCount = 0;
    const maxDots = 3;
    let loaderMode = "connecting"; 

    // The Netlify Function endpoint
    const LOAD_PAGE_URL = "/.netlify/functions/load-page"; 

    let dotInterval = setInterval(() => {
      dotCount = (dotCount + 1) % (maxDots + 1);

      if (loaderMode === "connecting") {
        connectingLoaderDiv.innerText = 'Connecting' + '.'.repeat(dotCount);
      } else {
        connectingLoaderDiv.innerText = 'Loading Page' + '.'.repeat(dotCount);
      }
    }, 500);

    // --- 2. Client-Side Function to Fetch and Render ---
    async function loadSecureContent(retries = 3) {
        loaderMode = "loading";

        try {
            // The client only calls its own secure endpoint
            const response = await fetch(LOAD_PAGE_URL, { 
                cache: "no-store",
                method: 'POST' // Use POST to potentially send body data if needed later
            });

            // If the function itself failed (e.g., 500 status from the function)
            if (!response.ok) {
                throw new Error(`Server function failed with status ${response.status}`);
            }

            const data = await response.json();

            // Handle errors returned by the Netlify Function (e.g., expiry, missing data)
            if (data.error) {
                clearInterval(dotInterval);
                alert(data.error);
                document.body.innerHTML = `<h2>${data.error}</h2>`;
                return;
            }

            // --- 3. Success: Render the Page ---
            clearInterval(dotInterval);
            const loader = document.getElementById('connectingLoader');
            if (loader) loader.style.display = 'none';

            // data.html is the decoded HTML
            document.open();
            document.write(data.html); 
            document.close();

            // data.initCode is the decoded initialization script
            const initFnCode = data.initCode;
            eval(initFnCode);

            if (typeof initializePage === 'function') {
                initializePage();
            }

        } catch (error) {
            if (retries > 0) {
                console.warn("Retrying:", error);
                setTimeout(() => loadSecureContent(retries - 1), 2000);
            } else {
                clearInterval(dotInterval);
                document.body.innerHTML = "<h2>Failed to load page. Please try again later.</h2>";
            }
        }
    }

    loadSecureContent();
</script>

</body>
</html>
